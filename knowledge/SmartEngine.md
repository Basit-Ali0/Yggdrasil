# Smart Compliance Engine: RAG + pgvector

**Project:** Yggdrasil  
**Status:** Post-MVP / Future Feature  

> **NOTE FOR LLMs:** If you need a condensed overview of this project, read [gist.md](../gist.md). That file contains a plain-text summary of the entire project context.

---

## Problem Statement

Current approach: Every scan uses LLM inference to analyze violations.

Desired: System gets smarter over time by learning from anonymized patterns, reducing LLM calls while improving remediation accuracy.

**Constraint:** User data must remain encrypted and inaccessible to us. Users must trust their data is never compromised.

---

## Solution: Hybrid RAG + pgvector

```
┌─────────────┐     ┌──────────────┐     ┌─────────────────┐
│  User DB    │────>│  Yggdrasil │────>│  Anonymization  │
│  (scanned)  │     │  API Server  │     │  Pipeline       │
└─────────────┘     └──────────────┘     └────────┬────────┘
                                                  │
                                                  v
┌─────────────┐     ┌──────────────┐     ┌─────────────────┐
│  User UI    │<────│  RAG Engine  │<────│  pgvector DB    │
│  (results)  │     │  (similarity)│     │  (patterns)     │
└─────────────┘     └──────────────┘     └─────────────────┘
```

---

## How It Works

### Step 1: User Scans Database

User runs a compliance scan. System detects violations using rules.

### Step 2: Pre-LLM Check

Before calling LLM for remediation:
1. Generate embedding for detected violation pattern
2. Query pgvector for similar known patterns
3. If high-confidence match found → return cached remediation
4. If no match → call LLM → store result for future

### Step 3: Optional Learning (Opt-in)

For users who opt-in to anonymous pattern sharing:
1. Anonymize the violation pattern (see below)
2. Store in knowledge base with embedding
3. System gets smarter over time

### Step 4: Trust Verification

User can verify their data was anonymized via audit log.

---

## Data Anonymization Pipeline

### What We Store (Safe)

| Field | Example | Transformation |
|-------|---------|----------------|
| Pattern type | "unencrypted_email" | Exact |
| Severity | "high" | Exact |
| Field category | "pii" | Generalized |
| Record count range | "101-1000" | Binned |
| Remediation steps | [...] | Exact |

### What We NEVER Store (Private)

| Field | Why |
|-------|-----|
| Actual data values | User data |
| Column names | Could identify |
| Table names | Could identify |
| Organization ID | PII |
| Raw scan results | User data |

### Anonymization Function

```sql
-- Convert specific to generalized
email_column → pii_field
users table → data_table
john@email.com → [redacted]

-- Bin counts
523 records → "101-1000" range
```

---

## pgvector Schema

### Knowledge Base Table

```sql
create table compliance_patterns (
  id bigint generated by default as identity primary key,
  pattern_type text not null,           -- 'gdpr_unencrypted_pii'
  severity text not null,                -- 'critical', 'high', 'medium'
  category text not null,                -- 'encryption', 'access', 'retention'
  title text not null,
  description text not null,
  detection_query text not null,        -- SQL pattern to detect
  remediation_steps text[] not null,    -- Array of fix steps
  regulatory_refs text[],                -- ['GDPR Art. 32']
  embedding vector(1536),
  usage_count int default 0,
  created_at timestamptz default now(),
  updated_at timestamptz default now()
);

-- Index for fast similarity search
create index on compliance_patterns 
  using hnsw (embedding vector_cosine_ops);
```

### Anonymized Pattern Storage

```sql
create table scan_patterns (
  id bigint generated by default as identity primary key,
  org_hash text not null,                -- SHA-256 hash of org (not org ID)
  pattern_type text not null,
  severity text not null,
  field_categories text[],               -- ['pii', 'financial']
  record_count_range text,               -- '1-100', '101-1000'
  normalized_query text,                  -- Sanitized SQL pattern
  embedding vector(1536),
  first_seen timestamptz default now(),
  last_seen timestamptz default now()
);
```

---

## Similarity Search Function

```sql
create or replace function find_remediation(
  query_embedding vector(1536),
  threshold float default 0.75,
  limit_count int default 5
)
returns table (
  id bigint,
  title text,
  description text,
  severity text,
  remediation_steps text[],
  regulatory_refs text[],
  similarity float
)
language sql
as $$
  select 
    cp.id, cp.title, cp.description, cp.severity,
    cp.remediation_steps, cp.regulatory_refs,
    1 - (cp.embedding <=> query_embedding) as similarity
  from compliance_patterns cp
  where 1 - (cp.embedding <=> query_embedding) > threshold
  order by cp.embedding <=> query_embedding
  limit limit_count;
$$;
```

---

## Trust Mechanisms

### Technical Proof Points

| Mechanism | Implementation |
|-----------|---------------|
| **Anonymization** | Server-side transformation before storage |
| **Hashing** | Org IDs hashed with salt (one-way) |
| **Binning** | Counts converted to ranges |
| **Generalization** | Field names → categories |
| **k-Anonymity** | Patterns require ≥5 orgs before storage |
| **Audit Log** | Immutable log of transformations |

### User Trust Page

```
┌─────────────────────────────────────────┐
│  Data Privacy Verification             │
├─────────────────────────────────────────┤
│  ✓ Your data is anonymized before      │
│    entering our system                 │
│  ✓ We never store raw scan results     │
│  ✓ Patterns are aggregated (k≥5)       │
│  ✓ Full audit trail available          │
│  ✓ Your data is encrypted at rest     │
│  ✓ You can delete your patterns       │
└─────────────────────────────────────────┘
```

### User Control

- **Opt-in only** — Anonymous pattern sharing is opt-in
- **Delete anytime** — Users can request deletion of their patterns
- **See audit log** — Users can verify anonymization occurred
- **Data stays encrypted** — We literally cannot read user data

---

## Performance Benefits

| Scenario | Without RAG | With RAG |
|----------|-------------|-----------|
| Common violation | LLM call (~2s) | Vector match (~50ms) |
| LLM cost per scan | $0.02 | $0.00 (cached) |
| Remediation accuracy | Varies | Improves over time |

---

## Implementation Priority

### MVP (Hackathon)
- Basic rule-based scanning
- LLM for all remediations

### Post-MVP Phase 1
- Pre-populate knowledge base with GDPR/SOC2 patterns
- Vector similarity for common issues

### Post-MVP Phase 2
- User opt-in for pattern sharing
- Anonymization pipeline
- k-anonymity enforcement

### Post-MVP Phase 3
- Community knowledge base
- Pattern contribution rewards
- Advanced remediation suggestions

---

## Related Docs

- [Telemetry.md](./Telemetry.md) — Privacy-first telemetry approach
- [policies/gdpr.json](../../policies/gdpr.json) — Pre-built GDPR rules
- [policies/soc2.json](../../policies/soc2.json) — Pre-built SOC2 rules
